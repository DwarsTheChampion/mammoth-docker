x-vanilla: &vanilla
    build: &vanilla_build
        context: .
        dockerfile: docker/vanilla.Dockerfile
    env_file: '.env'
    command: npm run start
    depends_on:
        migrations:
            condition: service_completed_successfully

x-world: &world
    <<: *vanilla
    build:
        <<: *vanilla_build
        args:
            PACKAGE: 'world'
    volumes:
        - ./data:/app/data

services:
    nginx:
        container_name: vanilla-nginx
        image: nginx:1.27-alpine
        volumes:
            - ./assets:/usr/share/nginx/html
            - ./config/nginx.conf.template:/etc/nginx/templates/default.conf.template
        environment:
            API_PORT: ${API_PORT}
            NGINX_PORT: ${NGINX_PORT}
        ports:
            - "${NGINX_PORT}:${NGINX_PORT}"
        depends_on:
            - api

    mariadb:
        container_name: vanilla-mariadb
        image: mariadb:11.4
        volumes:
            - vanilla-mariadb-data:/var/lib/mysql
        environment:
            MYSQL_USER: ${MYSQL_USER}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD}
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            MYSQL_DATABASE: ${MYSQL_DATABASE}
        healthcheck:
            test: sh -c "healthcheck.sh --connect --innodb_initialized"
            interval: 3s
            retries: 30

    redis:
        container_name: vanilla-redis
        image: redis:7.4-alpine
        command: redis-server --requirepass ${REDIS_PASSWORD}

    migrations:
        container_name: vanilla-migrations
        build:
            context: .
            dockerfile: docker/migrations.Dockerfile
        environment:
            DATABASE_URL: ${DATABASE_URL}
        command: prisma migrate deploy
        depends_on:
            mariadb:
                condition: service_healthy

    websockify:
        container_name: vanilla-websockify
        build:
            context: .
            dockerfile: docker/websockify.Dockerfile
        volumes:
            - ./scripts/websockify.sh:/app/websockify.sh
        env_file: .env
        command: sh -c "./websockify.sh"
        ports:
            - "${WS_JOIN_PORT}:${WS_JOIN_PORT}"
            - "${WS_BLIZZARD_PORT}:${WS_BLIZZARD_PORT}"

    api:
        <<: *vanilla
        container_name: vanilla-api
        build:
            <<: *vanilla_build
            args:
                PACKAGE: 'api'

    join:
        <<: *vanilla
        container_name: vanilla-join
        build:
            <<: *vanilla_build
            args:
                PACKAGE: 'join'
        ports:
            - "${JOIN_PORT}:${JOIN_PORT}"

    policy:
        <<: *vanilla
        container_name: vanilla-policy
        build:
            <<: *vanilla_build
            args:
                PACKAGE: 'policy'
        ports:
            - "${POLICY_PORT}:${POLICY_PORT}"

    blizzard:
        <<: *world
        container_name: vanilla-blizzard
        command: npm run start -- -i 100 -n Blizzard -p ${BLIZZARD_PORT}
        ports:
            - "${BLIZZARD_PORT}:${BLIZZARD_PORT}"

volumes:
    vanilla-mariadb-data:
